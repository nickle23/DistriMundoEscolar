<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administraci√≥n - Mundo Escolar</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .admin-header { background: linear-gradient(135deg, #0056b3 0%, #003d82 100%); }
        .stat-card { transition: transform 0.2s; }
        .stat-card:hover { transform: translateY(-2px); }
        .table-hover tbody tr:hover { background-color: rgba(0, 123, 255, 0.05); }
        .btn-action { padding: 0.25rem 0.5rem; font-size: 0.875rem; }
    </style>
</head>
<body>
    <!-- Header -->
    <nav class="navbar navbar-dark admin-header">
        <div class="container">
            <span class="navbar-brand mb-0 h1">
                <i class="bi bi-shield-lock me-2"></i>Panel de Administraci√≥n
            </span>
            <div class="navbar-nav ms-auto">
                <a href="/logout" class="btn btn-outline-light btn-sm">
                    <i class="bi bi-box-arrow-right me-1"></i>Cerrar Sesi√≥n
                </a>
            </div>
        </div>
    </nav>

    <div class="container-fluid py-4">
        <!-- Estad√≠sticas -->
        <div class="row mb-4">
            <div class="col-md-3 mb-3">
                <div class="card stat-card border-0 shadow-sm">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title text-muted">Total Vendedores</h6>
                                <h3 class="text-primary" id="total-vendedores">0</h3>
                            </div>
                            <div class="align-self-center">
                                <i class="bi bi-people-fill text-primary fs-2"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card stat-card border-0 shadow-sm">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title text-muted">Activos</h6>
                                <h3 class="text-success" id="contador-activos">0</h3>
                            </div>
                            <div class="align-self-center">
                                <i class="bi bi-check-circle-fill text-success fs-2"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card stat-card border-0 shadow-sm">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title text-muted">Con Device ID</h6>
                                <h3 class="text-info" id="contador-device-id">0</h3>
                            </div>
                            <div class="align-self-center">
                                <i class="bi bi-phone-fill text-info fs-2"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card stat-card border-0 shadow-sm">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title text-muted">Accesos Hoy</h6>
                                <h3 class="text-warning" id="accesos-hoy">0</h3>
                            </div>
                            <div class="align-self-center">
                                <i class="bi bi-graph-up text-warning fs-2"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Gesti√≥n de Vendedores -->
            <div class="col-lg-8 mb-4">
                <div class="card shadow-sm">
                    <div class="card-header bg-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Gesti√≥n de Vendedores</h5>
                        <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#modalAgregar">
                            <i class="bi bi-person-plus me-1"></i>Agregar Vendedor
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>C√≥digo</th>
                                        <th>Nombre</th>
                                        <th>Tipo</th>
                                        <th>Device ID</th>
                                        <th>Estado</th>
                                        <th>√öltimo Acceso</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="tabla-vendedores">
                                    <!-- Los vendedores se cargar√°n con JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Historial de Accesos Recientes -->
            <div class="col-lg-4">
                <div class="card shadow-sm">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">Accesos Recientes</h5>
                    </div>
                    <div class="card-body">
                        <div class="list-group list-group-flush" id="lista-accesos">
                            <!-- Los accesos se cargar√°n con JavaScript -->
                            <div class="list-group-item text-center text-muted">
                                Cargando accesos...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Agregar Vendedor -->
    <div class="modal fade" id="modalAgregar" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Agregar Nuevo Vendedor</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <form id="formAgregar" onsubmit="agregarVendedor(event)">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">C√≥digo del Vendedor</label>
                            <input type="text" class="form-control" name="codigo" required 
                                   placeholder="Ej: VEND-001" pattern="[A-Z0-9\-]+">
                            <div class="form-text">Usa may√∫sculas, n√∫meros y guiones</div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Nombre Completo</label>
                            <input type="text" class="form-control" name="nombre" required 
                                   placeholder="Nombre del vendedor">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Device ID (Opcional)</label>
                            <input type="text" class="form-control" name="device_id" 
                                   placeholder="Pegar el Device ID aqu√≠">
                            <div class="form-text">
                                <a href="/obtener-id" target="_blank">Obtener Device ID</a>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Agregar Vendedor</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Editar Vendedor -->
    <div class="modal fade" id="modalEditar" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Editar Vendedor</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <form id="formEditar" onsubmit="guardarEdicion(event)">
                    <div class="modal-body">
                        <input type="hidden" id="editCodigo" name="codigo_actual">
                        <div class="mb-3">
                            <label class="form-label">C√≥digo del Vendedor</label>
                            <input type="text" class="form-control" id="editCodigoInput" name="nuevo_codigo" required 
                                   placeholder="Nuevo c√≥digo" pattern="[A-Z0-9\-]+">
                            <div class="form-text">Al cambiar el c√≥digo, el vendedor ser√° deslogueado autom√°ticamente</div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Nombre Completo</label>
                            <input type="text" class="form-control" id="editNombre" name="nombre" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Device ID</label>
                            <input type="text" class="form-control" id="editDeviceId" name="device_id" 
                                   placeholder="Pegar el Device ID aqu√≠">
                            <div class="form-text">
                                <a href="/obtener-id" target="_blank">Obtener Device ID</a>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="editActivo" name="activo" value="on">
                                <label class="form-check-label" for="editActivo">Vendedor Activo</label>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="editEsAdmin" name="es_admin" value="on">
                                <label class="form-check-label" for="editEsAdmin">Acceso de Administrador</label>
                            </div>
                            <div class="form-text text-warning">
                                <i class="bi bi-exclamation-triangle"></i>
                                Los administradores pueden gestionar otros usuarios
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Guardar Cambios</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Cargar todos los datos cuando la p√°gina se carga
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üîÑ Cargando panel admin...');
            
            // ‚úÖ NUEVO: Configurar limpieza autom√°tica del modal de agregar
            const modalAgregar = document.getElementById('modalAgregar');
            modalAgregar.addEventListener('show.bs.modal', function () {
                // Limpiar el formulario cuando se abre el modal
                document.getElementById('formAgregar').reset();
            });
            
            cargarVendedores();
            cargarAccesos();
        });

        // Cargar lista de vendedores
        async function cargarVendedores() {
            try {
                console.log('üìû Llamando a /admin/vendedores...');
                const response = await fetch('/admin/vendedores', {
                    credentials: 'include'  // IMPORTANTE: incluir cookies de sesi√≥n
                });
                
                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status} - ${response.statusText}`);
                }
                
                const vendedores = await response.json();
                console.log('‚úÖ Vendedores cargados:', Object.keys(vendedores).length);
                
                actualizarEstadisticas(vendedores);
                mostrarVendedoresEnTabla(vendedores);
                
            } catch (error) {
                console.error('‚ùå Error cargando vendedores:', error);
                document.getElementById('tabla-vendedores').innerHTML = 
                    '<tr><td colspan="7" class="text-center text-danger">Error cargando vendedores: ' + error.message + '</td></tr>';
            }
        }

        // Cargar historial de accesos
        async function cargarAccesos() {
            try {
                console.log('üìû Llamando a /admin/historial-accesos...');
                const response = await fetch('/admin/historial-accesos', {
                    credentials: 'include'  // IMPORTANTE: incluir cookies de sesi√≥n
                });
                
                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status} - ${response.statusText}`);
                }
                
                const accesos = await response.json();
                console.log('‚úÖ Accesos cargados:', accesos.length, 'registros');
                mostrarAccesosRecientes(accesos);
                
            } catch (error) {
                console.error('‚ùå Error cargando accesos:', error);
                document.getElementById('lista-accesos').innerHTML = 
                    '<div class="list-group-item text-center text-danger">Error cargando accesos: ' + error.message + '</div>';
            }
        }

        // Actualizar las estad√≠sticas
        function actualizarEstadisticas(vendedores) {
            let total = 0;
            let activos = 0;
            let conDeviceId = 0;
            let administradores = 0;
            
            for (const codigo in vendedores) {
                total++;
                if (vendedores[codigo].activo) {
                    activos++;
                }
                if (vendedores[codigo].device_id && vendedores[codigo].device_id.trim()) {
                    conDeviceId++;
                }
                if (vendedores[codigo].es_admin) {
                    administradores++;
                }
            }
            
            document.getElementById('total-vendedores').textContent = total;
            document.getElementById('contador-activos').textContent = activos;
            document.getElementById('contador-device-id').textContent = conDeviceId;
            console.log(`üìä Estad√≠sticas: ${total} total, ${activos} activos, ${conDeviceId} con device ID, ${administradores} administradores`);
        }

        // Mostrar vendedores en la tabla
        function mostrarVendedoresEnTabla(vendedores) {
            const tbody = document.getElementById('tabla-vendedores');
            tbody.innerHTML = '';
            
            if (Object.keys(vendedores).length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No hay vendedores registrados</td></tr>';
                return;
            }
            
            for (const [codigo, datos] of Object.entries(vendedores)) {
                const fila = document.createElement('tr');
                
                // Formatear √∫ltima fecha de acceso
                let ultimoAcceso = 'Nunca';
                if (datos.ultimo_acceso) {
                    const fecha = new Date(datos.ultimo_acceso);
                    // ‚úÖ CORRECCI√ìN HORA PER√ö para √∫ltima conexi√≥n
                    fecha.setHours(fecha.getHours() - 5);
                    ultimoAcceso = fecha.toLocaleString('es-ES', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                }
                
                // Preparar datos para el modal (escapar comillas simples)
                const nombreSeguro = escapeHtml(datos.nombre || '').replace(/'/g, "\\'");
                const deviceIdSeguro = (datos.device_id || '').replace(/'/g, "\\'");
                const esAdmin = datos.es_admin || false;
                const activo = datos.activo !== false; // Por defecto activo
                
                fila.innerHTML = `
                    <td><strong>${codigo}</strong></td>
                    <td>${escapeHtml(datos.nombre || '')}</td>
                    <td>
                        ${esAdmin ? 
                            '<span class="badge bg-danger">Administrador</span>' : 
                            '<span class="badge bg-secondary">Vendedor</span>'}
                    </td>
                    <td>
                        ${deviceIdSeguro ? 
                            '<span class="badge bg-success">Configurado</span>' : 
                            '<span class="badge bg-warning">Pendiente</span>'}
                    </td>
                    <td>
                        ${activo ? 
                            '<span class="badge bg-success">Activo</span>' : 
                            '<span class="badge bg-danger">Inactivo</span>'}
                    </td>
                    <td>${ultimoAcceso}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary btn-action" 
                                onclick="editarVendedor('${codigo}', '${nombreSeguro}', '${deviceIdSeguro}', ${activo}, ${esAdmin})">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-warning btn-action ms-1" 
                                onclick="desloguearVendedor('${codigo}', '${nombreSeguro}')">
                            <i class="bi bi-box-arrow-right"></i>
                        </button>
                        ${codigo !== 'DARKEYES' ? 
                            `<button class="btn btn-sm btn-outline-danger btn-action ms-1" 
                                    onclick="eliminarVendedor('${codigo}', '${nombreSeguro}')">
                                <i class="bi bi-trash"></i>
                            </button>` : ''}
                    </td>
                `;
                
                tbody.appendChild(fila);
            }
            
            console.log('‚úÖ Tabla de vendedores actualizada');
        }

        // Mostrar accesos recientes
        function mostrarAccesosRecientes(accesos) {
            const lista = document.getElementById('lista-accesos');
            lista.innerHTML = '';
            
            // Ordenar accesos por fecha (m√°s recientes primero) y tomar √∫ltimos 20
            const accesosRecientes = accesos
                .sort((a, b) => new Date(b.fecha_hora) - new Date(a.fecha_hora))
                .slice(0, 20);
            
            if (accesosRecientes.length === 0) {
                lista.innerHTML = '<div class="list-group-item text-center text-muted">No hay accesos registrados</div>';
                return;
            }
            
            // Calcular accesos de hoy para estad√≠sticas
            const hoy = new Date().toISOString().split('T')[0];
            const accesosHoy = accesos.filter(a => a.fecha_hora && a.fecha_hora.startsWith(hoy)).length;
            document.getElementById('accesos-hoy').textContent = accesosHoy;
            
            // Mostrar accesos en la lista
            accesosRecientes.forEach(acceso => {
                const item = document.createElement('div');
                item.className = 'list-group-item px-0';
                
                const fecha = acceso.fecha_hora ? new Date(acceso.fecha_hora) : null;
                
                // ‚úÖ CORRECCI√ìN HORA PER√ö: Restar 5 horas (UTC-5)
                if (fecha) {
                    fecha.setHours(fecha.getHours() - 5);
                }
                
                const hora = fecha ? fecha.toLocaleTimeString('es-ES', {hour: '2-digit', minute: '2-digit'}) : '--:--';
                const fechaStr = fecha ? fecha.toLocaleDateString('es-ES') : '----';
                
                item.innerHTML = `
                    <div class="d-flex w-100 justify-content-between">
                        <h6 class="mb-1">
                            ${acceso.exitoso ? 
                                '<i class="bi bi-check-circle-fill text-success me-1"></i>' : 
                                '<i class="bi bi-x-circle-fill text-danger me-1"></i>'}
                            ${escapeHtml(acceso.vendedor_id || 'Desconocido')}
                        </h6>
                        <small>${hora}</small>
                    </div>
                    <p class="mb-1 small text-muted">
                        ${fechaStr} ‚Ä¢ 
                        ${acceso.dispositivo ? 
                            `ID: ${acceso.dispositivo.substring(0, 8)}...` : 
                            'Sin ID'}
                    </p>
                `;
                
                lista.appendChild(item);
            });
            
            console.log('‚úÖ Lista de accesos actualizada con hora de Per√∫');
        }

        // Funci√≥n para escapar HTML (seguridad)
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Funciones para gestionar vendedores
        async function agregarVendedor(event) {
            event.preventDefault();
            console.log('üîÑ Intentando agregar vendedor...');
            
            const formData = new FormData(event.target);
            
            try {
                const response = await fetch('/admin/agregar-vendedor', {
                    method: 'POST',
                    body: formData,
                    credentials: 'include'
                });
                const data = await response.json();
                
                if (data.success) {
                    alert('‚úÖ ' + data.mensaje);
                    
                    // ‚úÖ NUEVO: Limpiar el formulario despu√©s de agregar exitosamente
                    event.target.reset();
                    
                    // Cerrar modal y recargar datos
                    const modal = bootstrap.Modal.getInstance(document.getElementById('modalAgregar'));
                    modal.hide();
                    cargarVendedores();
                } else {
                    alert('‚ùå Error: ' + data.error);
                }
            } catch (error) {
                console.error('Error al agregar vendedor:', error);
                alert('‚ùå Error al agregar vendedor: ' + error.message);
            }
        }

        function editarVendedor(codigo, nombre, deviceId, activo, esAdmin = false) {
            console.log('‚úèÔ∏è Editando vendedor:', { codigo, nombre, deviceId, activo, esAdmin });
            
            document.getElementById('editCodigo').value = codigo;
            document.getElementById('editCodigoInput').value = codigo;
            document.getElementById('editNombre').value = nombre;
            document.getElementById('editDeviceId').value = deviceId || '';
            document.getElementById('editActivo').checked = activo;
            document.getElementById('editEsAdmin').checked = esAdmin;
            
            // Mostrar el modal
            const modal = new bootstrap.Modal(document.getElementById('modalEditar'));
            modal.show();
            
            console.log('‚úÖ Modal de edici√≥n abierto');
        }

        async function guardarEdicion(event) {
            event.preventDefault();
            const codigoActual = document.getElementById('editCodigo').value;
            console.log('üíæ Guardando cambios para:', codigoActual);
            
            const formData = new FormData(event.target);
            
            try {
                const response = await fetch(`/admin/editar-vendedor/${codigoActual}`, {
                    method: 'POST',
                    body: formData,
                    credentials: 'include'
                });
                const data = await response.json();
                
                if (data.success) {
                    if (data.sesion_cerrada) {
                        alert('‚úÖ ' + data.mensaje);
                        // Redirigir al login despu√©s de 2 segundos
                        setTimeout(() => {
                            window.location.href = data.redirect_url || '/';
                        }, 2000);
                    } else {
                        alert('‚úÖ ' + data.mensaje);
                        // Cerrar modal y recargar datos
                        const modal = bootstrap.Modal.getInstance(document.getElementById('modalEditar'));
                        modal.hide();
                        cargarVendedores();
                    }
                } else {
                    alert('‚ùå Error: ' + data.error);
                }
            } catch (error) {
                console.error('Error al editar vendedor:', error);
                alert('‚ùå Error al editar vendedor: ' + error.message);
            }
        }

        async function desloguearVendedor(codigo, nombre) {
            const nombreSeguro = nombre.replace(/\\'/g, "'");
            if (confirm(`¬øForzar cierre de sesi√≥n para "${nombreSeguro}" (${codigo})?\n\nSe le expulsar√° inmediatamente del sistema.`)) {
                console.log('üö´ Forzando cierre de sesi√≥n para:', codigo);
                
                try {
                    const response = await fetch(`/admin/desloguear-vendedor/${codigo}`, {
                        method: 'POST',
                        credentials: 'include'
                    });
                    const data = await response.json();
                    
                    if (data.success) {
                        alert('‚úÖ ' + data.mensaje);
                        // NO recargar la p√°gina - solo mostrar mensaje
                        console.log('‚úÖ Vendedor deslogueado exitosamente');
                    } else {
                        alert('‚ùå Error: ' + data.error);
                    }
                } catch (error) {
                    console.error('Error al desloguear vendedor:', error);
                    alert('‚ùå Error al desloguear vendedor: ' + error.message);
                }
            }
        }

        async function eliminarVendedor(codigo, nombre) {
            const nombreSeguro = nombre.replace(/\\'/g, "'");
            if (confirm(`¬øEst√°s seguro de eliminar al vendedor "${nombreSeguro}" (${codigo})?\n\nEsta acci√≥n no se puede deshacer.`)) {
                console.log('üóëÔ∏è Eliminando vendedor:', codigo);
                
                try {
                    const response = await fetch(`/admin/eliminar-vendedor/${codigo}`, {
                        method: 'POST',
                        credentials: 'include'
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        // ‚úÖ CORREGIDO: Remover la fila de la tabla sin recargar toda la p√°gina
                        const filas = document.querySelectorAll('#tabla-vendedores tr');
                        for (let fila of filas) {
                            const codigoFila = fila.querySelector('td:first-child strong')?.textContent;
                            if (codigoFila === codigo) {
                                fila.remove();
                                break;
                            }
                        }
                        
                        // ‚úÖ Actualizar estad√≠sticas sin recargar
                        cargarVendedores();
                        
                        alert('‚úÖ ' + data.mensaje);
                        console.log('‚úÖ Vendedor eliminado exitosamente');
                    } else {
                        alert('‚ùå Error: ' + data.error);
                    }
                } catch (error) {
                    console.error('Error al eliminar vendedor:', error);
                    alert('‚ùå Error al eliminar vendedor: ' + error.message);
                }
            }
        }
    </script>
</body>
</html>